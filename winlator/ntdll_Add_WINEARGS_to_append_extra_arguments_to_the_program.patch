From 019cb42d468a730b085055cd4ca7956a9e8f291b Mon Sep 17 00:00:00 2001
From: BrunoSX <brunodeveloper85@gmail.com>
Date: Mon, 21 Jul 2025 17:55:00 -0300
Subject: [PATCH] ntdll: Add WINEARGS to append extra arguments to the program

---
 dlls/ntdll/unix/env.c | 43 +++++++++++++++++++++++++++++++++++++++----
 1 file changed, 39 insertions(+), 4 deletions(-)

diff --git a/dlls/ntdll/unix/env.c b/dlls/ntdll/unix/env.c
index ad9ab0dc..9fdc4be4 100755
--- a/dlls/ntdll/unix/env.c
+++ b/dlls/ntdll/unix/env.c
@@ -1682,6 +1682,16 @@ static inline void put_unicode_string( WCHAR *src, WCHAR **dst, UNICODE_STRING *
     copy_unicode_string( &src, dst, str, wcslen(src) * sizeof(WCHAR) );
 }
 
+static inline void append_unicode_string( WCHAR *src, WCHAR **dst, UNICODE_STRING *str )
+{
+    UINT len = wcslen(src) * sizeof(WCHAR);
+    str->Length += len;
+    str->MaximumLength += len + sizeof(WCHAR);
+    memcpy( *dst, src, len );
+    (*dst)[len / sizeof(WCHAR)] = 0;
+    *dst += len / sizeof(WCHAR) + 1;
+}
+
 static inline WCHAR *get_dos_path( WCHAR *nt_path )
 {
     if (nt_path[4] && nt_path[5] == ':') return nt_path + 4; /* skip the \??\ prefix */
@@ -2027,10 +2037,11 @@ static RTL_USER_PROCESS_PARAMETERS *build_initial_params( void **module )
  */
 void init_startup_info(void)
 {
-    WCHAR *src, *dst, *env, *image;
+    WCHAR *src, *dst, *env, *image, *extra_args;
+    char *wine_args;
     void *module = NULL;
     unsigned int status;
-    SIZE_T size, info_size, env_size, env_pos;
+    SIZE_T size, info_size, env_size, env_pos, extra_args_len;
     RTL_USER_PROCESS_PARAMETERS *params = NULL;
     startup_info_t *info;
     USHORT machine;
@@ -2061,12 +2072,26 @@ void init_startup_info(void)
     add_dynamic_environment( &env, &env_pos, &env_size );
     is_prefix_bootstrap = !!find_env_var( env, env_pos, bootstrapW, ARRAY_SIZE(bootstrapW) );
     env[env_pos++] = 0;
+    
+    extra_args = NULL;
+    extra_args_len = 0;
+    
+    wine_args = getenv( "WINEARGS" );
+    if (wine_args)
+    {
+        SIZE_T len = strlen(wine_args) + 1;
+        extra_args_len = len * sizeof(WCHAR);
+        extra_args = malloc( extra_args_len );
+        ntdll_umbstowcs( wine_args, len, extra_args + 1, len );
+        extra_args[0] = L' ';
+        unsetenv( "WINEARGS" );
+    }
 
     size = (sizeof(*params)
             + MAX_PATH * sizeof(WCHAR)  /* curdir */
             + info->dllpath_len + sizeof(WCHAR)
             + info->imagepath_len + sizeof(WCHAR)
-            + info->cmdline_len + sizeof(WCHAR)
+            + info->cmdline_len + extra_args_len + sizeof(WCHAR)
             + info->title_len + sizeof(WCHAR)
             + info->desktop_len + sizeof(WCHAR)
             + info->shellinfo_len + sizeof(WCHAR)
@@ -2107,7 +2132,17 @@ void init_startup_info(void)
 
     if (info->dllpath_len) copy_unicode_string( &src, &dst, &params->DllPath, info->dllpath_len );
     copy_unicode_string( &src, &dst, &params->ImagePathName, info->imagepath_len );
-    copy_unicode_string( &src, &dst, &params->CommandLine, info->cmdline_len );
+    
+    if (extra_args && info->cmdline_len > 0) {
+        WCHAR *old = dst;
+        copy_unicode_string( &src, &dst, &params->CommandLine, info->cmdline_len );
+        dst = old + (info->cmdline_len / sizeof(WCHAR));
+        append_unicode_string( extra_args, &dst, &params->CommandLine );
+
+        free(extra_args);
+        extra_args = NULL;
+    } else copy_unicode_string( &src, &dst, &params->CommandLine, info->cmdline_len );
+
     copy_unicode_string( &src, &dst, &params->WindowTitle, info->title_len );
     copy_unicode_string( &src, &dst, &params->Desktop, info->desktop_len );
     copy_unicode_string( &src, &dst, &params->ShellInfo, info->shellinfo_len );
